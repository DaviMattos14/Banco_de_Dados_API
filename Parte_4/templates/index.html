<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Dashboard GTFS - Rio de Janeiro</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <style>
        body { font-family: sans-serif; padding: 20px; background-color: #f4f4f9; }
        h1, h2 { text-align: center; color: #333; }
        .chart-container { 
            width: 80%; max-width: 700px; margin: 40px auto; padding: 20px;
            background-color: #fff; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 12px 15px; border: 1px solid #ddd; text-align: left; }
        thead th { background-color: #337ab7; color: white; font-weight: bold; }
        tbody tr:nth-child(even) { background-color: #f2f2f2; }

        /* --- INÍCIO DOS NOVOS ESTILOS --- */
        .search-controls {
            display: flex; gap: 15px; align-items: center; justify-content: center;
            margin-bottom: 20px; flex-wrap: wrap;
        }
        .search-controls input { font-size: 16px; padding: 8px; width: 120px; border: 1px solid #ccc; border-radius: 4px;}
        .search-controls button { 
            font-size: 16px; padding: 8px 15px; cursor: pointer; 
            background-color: #337ab7; color: white; border: none; border-radius: 4px;
        }
        .search-controls button:hover { background-color: #286090; }
        .search-controls span { font-size: 16px; font-weight: bold; }
        /* --- FIM DOS NOVOS ESTILOS --- */
    </style>
</head>
<body>
    <h1>Dashboard de Transporte - Rio de Janeiro</h1>

    <!-- INÍCIO DA NOVA SEÇÃO DE BUSCA DE ITINERÁRIO -->
    <div class="chart-container">
        <h2>Consultar Itinerário da Linha</h2>
        <div class="search-controls">
            <input type="text" id="linhaInput" placeholder="Nº da Linha" aria-label="Número da Linha">
            <button id="buscarBtn">Buscar</button>
            <span id="sentidoLabel">Sentido: 0</span>
            <button id="trocarSentidoBtn">Inverter Sentido</button>
        </div>
        <table>
            <thead>
                <tr>
                    <th>Sequência</th>
                    <th>Nome do Ponto de Parada</th>
                </tr>
            </thead>
            <tbody id="tabela-trajeto">
                <tr><td colspan="2">Digite o número de uma linha e clique em "Buscar".</td></tr>
            </tbody>
        </table>
    </div>
    <!-- FIM DA NOVA SEÇÃO -->

    <div class="chart-container">
        <h2>Linhas de Ônibus por Consórcio</h2>
        <canvas id="consorcioChart"></canvas>
    </div>

    <div class="chart-container">
        <h2>Nº de Linhas por Valor da Tarifa</h2>
        <canvas id="tarifaChart"></canvas>
    </div>

    <div class="chart-container">
        <h2>Status das Linhas (Ativas vs. Inativas)</h2>
        <canvas id="statusChart"></canvas>
    </div>
    
    <div class="chart-container">
        <h2>Status dos Pontos (Com vs. Sem Viagem)</h2>
        <canvas id="pontosChart"></canvas>
    </div>

    <div class="chart-container">
        <h2>Linhas que NÃO Operam nos Finais de Semana</h2>
        <table>
            <thead>
                <tr><th>Número da Linha</th><th>Nome da Linha</th></tr>
            </thead>
            <tbody id="tabela-linhas-sem-fds"></tbody>
        </table>
    </div>

    <script>
        Chart.register(ChartDataLabels);

        // Funções existentes (sem alterações)
        async function renderConsorcioChart() { /* ... código ... */ }
        async function renderTarifaChart() { /* ... código ... */ }
        async function renderStatusChart() { /* ... código ... */ }
        async function renderPontosChart() { /* ... código ... */ }
        async function renderLinhasTable() { /* ... código ... */ }

        // Mantendo o código das funções existentes exatamente como estava
        (async function() {
            // ... Colocando o corpo das funções aqui para garantir que o código final tenha tudo
            // Função para o gráfico de pizza de consórcios
            async function renderConsorcioChart() { const response = await fetch('/api/linhas_por_consorcio'); const data = await response.json(); const labels = data.map(item => item.nome_consorcio); const values = data.map(item => item.total_linhas); const ctx = document.getElementById('consorcioChart').getContext('2d'); new Chart(ctx, { type: 'pie', data: { labels: labels, datasets: [{ label: 'Nº de Linhas', data: values, backgroundColor: ['rgba(255, 99, 132, 0.7)', 'rgba(54, 162, 235, 0.7)', 'rgba(255, 206, 86, 0.7)', 'rgba(75, 192, 192, 0.7)', 'rgba(153, 102, 255, 0.7)', 'rgba(255, 159, 64, 0.7)'], borderColor: '#fff', borderWidth: 2 }] }, options: { responsive: true, plugins: { legend: { position: 'top', labels: { color: 'black', font: { size: 16 } } }, datalabels: { formatter: (value, context) => { const total = context.chart.data.datasets[0].data.reduce((a, b) => a + b, 0); const percentage = (value / total * 100).toFixed(1) + '%'; return percentage; }, color: '#000', font: { weight: '200', size: 18 }, textStrokeColor: 'black', textStrokeWidth: 1 } } } }); }
            // Função para o gráfico de barras de tarifas
            async function renderTarifaChart() { const response = await fetch('/api/linhas_por_tarifa'); const data = await response.json(); const labels = data.map(item => `R$ ${item.valor.toFixed(2).replace('.', ',')}`); const values = data.map(item => item.total_linhas); const ctx = document.getElementById('tarifaChart').getContext('2d'); new Chart(ctx, { type: 'bar', data: { labels: labels, datasets: [{ label: 'Quantidade de Linhas', data: values, backgroundColor: 'rgba(54, 162, 235, 0.7)', borderColor: 'rgba(54, 162, 235, 1)', borderWidth: 1 }] }, options: { responsive: true, plugins: { legend: { display: false }, datalabels: { anchor: 'center', align: 'center', color: 'black', font: { weight: 'bold' } } }, scales: { y: { beginAtZero: true, title: { display: true, text: 'Nº de Linhas' } }, x: { title: { display: true, text: 'Valor da Tarifa' } } } } }); }
            // Função para o gráfico de pizza de Status
            async function renderStatusChart() { const response = await fetch('/api/status_linhas'); const data = await response.json(); const labels = data.map(item => item.status_linha); const values = data.map(item => item.quantidade); const ctx = document.getElementById('statusChart').getContext('2d'); new Chart(ctx, { type: 'pie', data: { labels: labels, datasets: [{ label: 'Status', data: values, backgroundColor: ['rgba(75, 192, 192, 0.7)', 'rgba(255, 99, 132, 0.7)'], borderColor: '#fff', borderWidth: 2 }] }, options: { responsive: true, plugins: { legend: { position: 'top', labels: { color: 'black', font: { size: 16 } } }, datalabels: { formatter: (value, context) => { const total = context.chart.data.datasets[0].data.reduce((a, b) => a + b, 0); const percentage = (value / total * 100).toFixed(1) + '%'; return `${value}\n(${percentage})`; }, color: '#fff', font: { weight: 'bold', size: 14 }, textAlign: 'center', textStrokeColor: 'black', textStrokeWidth: 1 } } } }); }
            // Função para o gráfico de pontos
            async function renderPontosChart() { const response = await fetch('/api/status_pontos'); const data = await response.json(); const labels = data.map(item => item.status_ponto); const values = data.map(item => item.quantidade); const ctx = document.getElementById('pontosChart').getContext('2d'); new Chart(ctx, { type: 'pie', data: { labels: labels, datasets: [{ label: 'Status dos Pontos', data: values, backgroundColor: ['rgba(54, 162, 235, 0.7)', 'rgba(255, 159, 64, 0.7)'], borderColor: '#fff', borderWidth: 2 }] }, options: { responsive: true, plugins: { legend: { position: 'top', labels: { color: 'black', font: { size: 16 } } }, datalabels: { formatter: (value, context) => { const total = context.chart.data.datasets[0].data.reduce((a, b) => a + b, 0); const percentage = (value / total * 100).toFixed(1) + '%'; return `${value.toLocaleString('pt-BR')}\n(${percentage})`; }, color: '#fff', font: { weight: 'bold', size: 14 }, textAlign: 'center', textStrokeColor: 'black', textStrokeWidth: 1 } } } }); }
            // Função para a tabela de linhas sem fds
            async function renderLinhasTable() { const response = await fetch('/api/linhas_sem_fds'); const data = await response.json(); const tabelaBody = document.getElementById('tabela-linhas-sem-fds'); tabelaBody.innerHTML = ''; data.forEach(linha => { tabelaBody.innerHTML += `<tr><td>${linha.numero_linha}</td><td>${linha.nome_linha}</td></tr>`; }); }

            // --- INÍCIO DA NOVA LÓGICA DE BUSCA ---
            let currentSentido = 0;
            async function fetchAndShowTrajetoTable() {
                const linhaInput = document.getElementById('linhaInput');
                const numeroLinha = linhaInput.value.trim();
                const tabelaBody = document.getElementById('tabela-trajeto');
                if (!numeroLinha) { alert("Por favor, digite um número de linha."); return; }
                tabelaBody.innerHTML = '<tr><td colspan="2">Buscando...</td></tr>';
                try {
                    const response = await fetch(`/api/trajeto/${numeroLinha}/${currentSentido}`);
                    const data = await response.json();
                    tabelaBody.innerHTML = '';
                    if (data.length === 0) { tabelaBody.innerHTML = '<tr><td colspan="2">Nenhum trajeto encontrado.</td></tr>'; return; }
                    data.forEach(ponto => { tabelaBody.innerHTML += `<tr><td>${ponto.sequencia}</td><td>${ponto.nome_ponto}</td></tr>`; });
                } catch (error) { console.error('Falha ao buscar itinerário:', error); tabelaBody.innerHTML = '<tr><td colspan="2">Erro ao carregar dados.</td></tr>'; }
            }
            document.getElementById('buscarBtn').addEventListener('click', fetchAndShowTrajetoTable);
            document.getElementById('trocarSentidoBtn').addEventListener('click', () => {
                currentSentido = currentSentido === 0 ? 1 : 0;
                document.getElementById('sentidoLabel').textContent = `Sentido: ${currentSentido}`;
                if (document.getElementById('linhaInput').value.trim()) { fetchAndShowTrajetoTable(); }
            });
            // --- FIM DA NOVA LÓGICA DE BUSCA ---

            // Chama todas as funções na carga inicial da página
            renderConsorcioChart();
            renderTarifaChart();
            renderStatusChart();
            renderPontosChart();
            renderLinhasTable();
        })();
    </script>
</body>
</html>